# Playwright Header Pitfalls Cheat-Sheet

This document captures the most common header-related gotchas when using **Playwright** (or Puppeteer/Selenium) for browser automation and the corresponding work-arounds.

---

## 1. `extraHTTPHeaders` silently missing on WebSockets
* **Symptom** – HTTP API works, WS handshake fails (401 / 403).
* **Root cause** – Chromium does **not** apply `extraHTTPHeaders` to WebSocket upgrade requests.
* **Fixes / Work-arounds**
  * Switch to Firefox (its driver pipes the headers correctly).
  * Intercept the WS URL with `page.route()` and append the header there.
  * Use token/cookie auth instead of a custom header.
* **Ref** – Playwright issue [#28948](https://github.com/microsoft/playwright/issues/28948).

## 2. Custom header added via `page.route()` but value is lowercase / ignored
* **Symptom** – Server receives `x-myheader: value` instead of `X-MyHeader: VALUE`, or not at all.
* **Root cause** – Spec violation in Chromium network stack when header name/value contain uppercase characters after interception.
* **Fixes**
  * Force the value to the exact case the back-end expects before calling `route.continue({ headers })`.
  * Upgrade Playwright ≥ **1.44** (patch keeps values intact).
* **Ref** – Playwright issue [#22318](https://github.com/microsoft/playwright/issues/22318).

## 3. HTTP/2 pseudo-headers and overridden `Host` / `Content-Length`
* **Symptom** – `ERR_HTTP2_PROTOCOL_ERROR` or *431 "request header fields too large"*.
* **Root cause** – Disabling HTTP/2 while talking to a site that requires it, or adding forbidden pseudo-headers (`:authority`, `:scheme`, …).
* **Fixes**
  * **Avoid** `--disable-http2` unless absolutely necessary (now conditional via `DISABLE_HTTP2=1`).
  * Only modify regular headers; pseudo-headers are generated by the browser and cannot be overwritten.

## 4. Enterprise-policy-locked Chrome stripping headers
* **Symptom** – Header present locally, disappears in CI.
* **Root cause** – Corporate Chrome policies whitelisting/blacklisting outgoing headers.
* **Fixes**
  * Use Playwright's bundled Chromium instead of the system Chrome.
  * Optionally `--disable-features=OutOfBlinkCors` to bypass CORS header filtering (may vary).

## 5. CORS pre-flight rewriting
* **Symptom** – `OPTIONS` pre-flight succeeds, real `POST` fails 403 because custom header isn't present.
* **Root cause** – Header only injected on `POST` but server checks pre-flight's `Access-Control-Request-Headers` list.
* **Fixes**
  * Add the same header when intercepting the `OPTIONS` request.
  * Configure the server to allow the custom header.

## 6. Case-sensitive back-ends (legacy ASP.NET / Java servlets)
* **Symptom** – Header arrives, yet server says "header missing".
* **Root cause** – Older stacks honour *exact* casing; Chromium lower-cases names.
* **Fix**
  * Prefix with `x-` and consume header case-insensitively, or have a proxy rewrite the header.

## 7. Secure headers Playwright blocks from mutation
The browser ignores attempts to set or overwrite:
`accept-encoding`, `content-length`, `cookie` (via headers), `host`, `referer`, `user-agent`, `origin`, HTTP/2 `:authority`.

Use dedicated APIs instead:
* `context.setExtraHTTPHeaders()` for UA/lang.
* `page.setExtraHTTPHeaders({ referer: … })` **before** the first navigation.
* `context.addCookies()` for cookies.

If you must spoof these, place a reverse-proxy in front of the server.

---

### Quick troubleshooting checklist
1. Confirm the header is visible in the **Network** tab when replaying in headed/slow-mo mode.
2. Use `page.on('request', req => console.log(req.headers()))` to log exactly what Chromium is sending.
3. Test with **Firefox**; if it passes, suspect the Chromium WebSocket/header bug.
4. Eliminate extra launch flags (`--disable-http2`, `--proxy-server`, …) one by one.
5. Run on Playwright's bundled Chromium (no enterprise policies).
6. Still stuck? Intercept with an external proxy (mitmproxy/Fiddler) and diff the headers between manual and automated sessions. 